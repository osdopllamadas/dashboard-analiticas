/**
 * Middleware de Next.js para Multi-tenancy
 * 
 * Este middleware:
 * 1. Verifica la autenticación del usuario
 * 2. Inyecta el cliente de Supabase dinámico en el request
 * 3. Protege rutas que requieren autenticación
 */

import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
    const res = NextResponse.next();

    // Crear cliente de Supabase para el middleware
    const supabase = createMiddlewareClient({ req, res });

    // Verificar sesión del usuario
    const {
        data: { session },
    } = await supabase.auth.getSession();

    const isAuthPage = req.nextUrl.pathname.startsWith('/login') ||
        req.nextUrl.pathname.startsWith('/register');
    const isDashboardPage = req.nextUrl.pathname.startsWith('/dashboard') ||
        req.nextUrl.pathname.startsWith('/calls') ||
        req.nextUrl.pathname.startsWith('/analytics') ||
        req.nextUrl.pathname.startsWith('/suggestions') ||
        req.nextUrl.pathname.startsWith('/settings');

    // Redirigir a login si no está autenticado y trata de acceder al dashboard
    if (!session && isDashboardPage) {
        const redirectUrl = req.nextUrl.clone();
        redirectUrl.pathname = '/login';
        redirectUrl.searchParams.set('redirectedFrom', req.nextUrl.pathname);
        return NextResponse.redirect(redirectUrl);
    }

    // Redirigir al dashboard si está autenticado y trata de acceder a login
    if (session && isAuthPage) {
        const redirectUrl = req.nextUrl.clone();
        redirectUrl.pathname = '/dashboard';
        return NextResponse.redirect(redirectUrl);
    }

    // Agregar headers de seguridad
    res.headers.set('X-Frame-Options', 'DENY');
    res.headers.set('X-Content-Type-Options', 'nosniff');
    res.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
    res.headers.set(
        'Permissions-Policy',
        'camera=(), microphone=(), geolocation=()'
    );

    return res;
}

// Configurar qué rutas deben pasar por el middleware
export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - public folder
         */
        '/((?!_next/static|_next/image|favicon.ico|public).*)',
    ],
};
